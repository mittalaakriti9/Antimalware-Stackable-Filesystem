#include <sys/ioctl.h>
#include <stdio.h>
#include <errno.h>
#include <stdlib.h>
#include "header.h"
#include <fcntl.h>

int main(int argc, char *argv[])
{
	      
	int rc=-1;
        int aflag=0;
	int rflag=0;
        int lflag=0;
        int option;
        int err=0;
	char *mount_point,*test;
        int err1=0;
        extern char *optarg;
        extern int optind;
        int fd=-1;
	#ifdef EC
	int kflag=0;
	#endif
	


	test=(char*)malloc(256);

        /* Parsing options using the getopt() function. Checks for all bad inputs */
        while((option=getopt(argc,argv,"a:r:lk:"))!=-1){
                switch(option){
                        case 'a':
                                if(aflag==1){
                                        printf("WARNING! Append option stated multiple number of times\n");
                                }
				test=optarg;
                                aflag=1;
                                break;
                        case 'r':
                                if(rflag==1){
                                        printf("WARNING! Remove option stated multiple number of times\n");

				 }
				test=optarg;
				rflag=1;
                                break;
                        case 'l':
                                if(lflag==1){
                                        printf("WARNING! List option stated multiple number of times\n");
                                }
                                lflag=1;
                                break;
			#ifdef EC
			case 'k':
				if(kflag==1){
					printf("WARNING! Key flag stated multiple number of times\n");
				}
				test=optarg;
				kflag=1;
				break;
			#endif
			case 'h':
                                printf("**********This is an ioctl module interface to modify patterndb file************\n");
                                printf("Enter -a option along with the pattern to append a pattern to the patterndb file\n");
                                printf("Enter -r option along with the pattern to remove pattern from the patterndb file\n");
                                printf("Enter -l option to list all the patterns in the patterndb file\n");
                                err1=1;
                                break;
		       case '?':
                                err=1;
                                break;
                        default:
                                printf("Enter -a to append pattern or -d to decrypt the file along with input and output filenames\n");
                                break;
		}

	}

 /* checks if any invalid option is entered */
        if(err==1){
                printf("Invalid option entered\n");
                exit(1);
        }
	/* checks if user has entered -h option */
        else if(err1==1){
                exit(1);
        }
	else if((optind+1)>argc){
                printf("Missing Arguments\n");
                exit(1);
        }
	if(optind<argc){
                mount_point=argv[optind];

        }
	
	if((fd=open(mount_point,O_RDONLY))<0){
		perror("open");
		exit(1);
	}
	if(aflag==1){
	
		rc=ioctl(fd,AMFS_ADD_PATTERNS,test);
		if(rc<0)
			perror("Append Ioctl");
	}
	
	if(rflag==1){

                rc=ioctl(fd,AMFS_DEL_PATTERNS,test);
                if(rc<0)
                        perror("Remove Ioctl");
        }
	
	if(lflag==1){

                rc=ioctl(fd,AMFS_LIST_PATTERNS,test);
                if(rc<0)
                        perror("List Ioctl");
		else{
			printf("Pattern %s",test);
		}
        }

	#ifdef EC
	if(kflag==1){
		printf("Key: %s\n",test);
		rc=ioctl(fd,AMFS_DECRYPTION_KEY,test);
		if(rc<0)
			perror("Decryption Key Ioctl");
		
	}	
	#endif
	exit(rc);

}












